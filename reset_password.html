<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> <!-- Changed to stable 6.0.0 -->
  
  <style>
    /* CSS Variables for Theming (Inherited and adapted from reset_password.html) */
    :root {
      --primary-accent-color: #4CAF50;
      --primary-accent-color-hover: #45a049;
      --background-gradient-start: #e0e7ff;
      --background-gradient-end: #c3d9ff;
      --text-color-primary: #333;
      --text-color-secondary: #666;
      --card-bg-color: rgba(240, 240, 240, 0.8);
      --input-bg-color: #e8e8e8;
      --input-bg-focus-color: #f5f5f5;
      --button-bg-color: #e0e0e0;
      --error-color: #e74c3c;
      --success-color: #27ae60;
      --warning-color: #f39c12; /* Added for strength bar */
      --info-color: #3498db; /* Added for strength bar */
      --neumorphic-shadow-light: 10px 10px 20px rgba(0, 0, 0, 0.1), -10px -10px 20px rgba(255, 255, 255, 0.7);
      --neumorphic-shadow-raised: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;
      --neumorphic-shadow-hover: 8px 8px 15px rgba(0, 0, 0, 0.15), -8px -8px 15px rgba(255, 255, 255, 0.85);
      --neumorphic-input-inset-shadow: inset 2px 2px 5px rgba(0,0,0,0.1), inset -2px -2px 5px rgba(255,255,255,0.7);
      --neumorphic-input-focus-shadow: inset 3px 3px 7px rgba(0,0,0,0.15), inset -3px -3px 7px rgba(255,255,255,0.85);
      --glass-filter: blur(10px);
      --glass-border: 1px solid rgba(255, 255, 255, 0.18);
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 16px;
      --border-radius-2xl: 24px;
    }
    body.dark-mode { /* Dark mode styles */
      --primary-accent-color: #6a0dad;
      --primary-accent-color-hover: #7b00ea;
      --background-gradient-start: #2a293a;
      --background-gradient-end: #3b3a4e;
      --text-color-primary: #f0f0f0;
      --text-color-secondary: #b0b0b0;
      --card-bg-color: rgba(32, 33, 36, 0.8);
      --input-bg-color: #2c2d30;
      --input-bg-focus-color: #38393c;
      --button-bg-color: #383838;
      --error-color: #ff6b6b;
      --success-color: #2ecc71;
      --warning-color: #f1c40f; 
      --info-color: #9b59b6; 
      --neumorphic-shadow-light: 10px 10px 20px rgba(0, 0, 0, 0.5), -10px -10px 20px rgba(60, 60, 60, 0.5);
      --neumorphic-shadow-raised: 5px 5px 10px #222, -5px -5px 10px #444;
      --neumorphic-shadow-hover: 8px 8px 15px rgba(0, 0, 0, 0.6), -8px -8px 15px rgba(70, 70, 70, 0.6);
      --neumorphic-input-inset-shadow: inset 2px 2px 5px rgba(0,0,0,0.5), inset -2px -2px 5px rgba(60,60,60,0.5);
      --neumorphic-input-focus-shadow: inset 3px 3px 7px rgba(0,0,0,0.6), inset -3px -3px 7px rgba(70,70,70,0.6);
      --glass-border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Specific styles for the forgot/reset password page */
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(to right bottom, var(--background-gradient-start), var(--background-gradient-end));
      font-family: 'Poppins', sans-serif;
      color: var(--text-color-primary);
      transition: background 0.3s ease;
    }
    .reset-container { /* Renamed from .forgot-container for consistency */
      background: var(--card-bg-color);
      padding: 40px;
      border-radius: var(--border-radius-2xl);
      box-shadow: var(--neumorphic-shadow-light);
      text-align: center;
      width: 420px; /* Slightly wider than 380px for better fit, matches forgot-password width */
      max-width: 90%;
      z-index: 1;
      backdrop-filter: var(--glass-filter);
      border: var(--glass-border);
    }
    .reset-container h2 {
      margin-bottom: 30px;
      color: var(--text-color-primary);
      font-weight: 600;
    }
    /* Ensure icons are part of the header styling */
    .reset-container h2 i {
      display: block;
      font-size: 2.5rem;
      color: var(--primary-accent-color);
      margin-bottom: 10px;
    }
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9em;
      color: var(--text-color-secondary);
    }
    .input-group input {
      width: 100%;
      padding: 12px 15px;
      border: none;
      border-radius: var(--border-radius-md);
      font-size: 1.1em;
      background: var(--input-bg-color);
      color: var(--text-color-primary);
      box-shadow: var(--neumorphic-input-inset-shadow);
      outline: none;
      box-sizing: border-box;
    }
    .input-group input:focus {
      box-shadow: var(--neumorphic-input-focus-shadow);
      background: var(--input-bg-focus-color);
    }

    /* Buttons - unified style */
    .btn-container {
      display: flex;
      flex-direction: column;
      gap: 15px; /* Spacing between buttons */
      margin-top: 20px;
    }

    button, .btn-link { /* Apply button styles to links too for consistency */
      padding: 12px 25px;
      border: none;
      border-radius: var(--border-radius-lg);
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
      text-decoration: none; /* For link buttons */
      display: inline-flex; /* For icons */
      justify-content: center;
      align-items: center;
      gap: 8px; /* Spacing for icon and text */
    }

    button:hover, .btn-link:hover {
      transform: translateY(-2px);
      box-shadow: var(--neumorphic-shadow-hover);
    }
    
    /* Specific button colors based on their type */
    #sendOTP { /* This corresponds to btn-info in old code */
      color: white; /* Light color for text */
      background: var(--primary-accent-color);
      box-shadow: var(--neumorphic-shadow-raised); /* Using raised shadow */
    }
    #sendOTP:hover {
      background: var(--primary-accent-color-hover);
    }

    #setPasswordBtn { /* This corresponds to btn-primary in old code */
      color: white; /* Light color for text */
      background: var(--primary-accent-color);
      box-shadow: var(--neumorphic-shadow-raised);
    }
    #setPasswordBtn:hover {
      background: var(--primary-accent-color-hover);
    }

    button:disabled, .btn-link:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--neumorphic-shadow-raised); /* Keep original shadow when disabled */
    }

    #backToLoginLink { /* This corresponds to btn-secondary in old code */
      color: var(--text-color-primary);
      background: var(--button-bg-color); /* General button background */
      box-shadow: var(--neumorphic-shadow-raised);
    }
    #backToLoginLink:hover {
      background: var(--input-bg-focus-color); /* Lighter hover for secondary */
    }

    #message {
      margin-top: 15px;
      font-weight: 500;
      text-align: center;
    }
    #message.error { color: var(--error-color); }
    #message.success { color: var(--success-color); }
    .spinner {
      margin-top: 20px;
      border: 4px solid var(--text-color-secondary);
      border-left-color: var(--primary-accent-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: none;
      margin-left: auto;
      margin-right: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Password Toggle Specific Styles (copied from login.html for consistency, with positioning fix) */
    .input-field-wrapper {
        position: relative;
        width: 100%;
    }
    /* Adjust input padding to make space for the icon on the right */
    .input-field-wrapper input {
        padding-right: 45px; /* Enough space for the icon */
    }
    .password-toggle {
        position: absolute;
        right: 15px; /* Position from the right edge */
        top: 50%;
        transform: translateY(-50%); /* Perfectly center vertically */
        cursor: pointer;
        color: var(--text-color-secondary);
        font-size: 0.9em;
        transition: color 0.2s ease;
        display: none; /* Hidden by default, JS controls visibility */
        z-index: 2; /* Ensure it's above the input field */
    }

    /* Password Strength Bar */
    #passwordStrength {
      height: 5px;
      border-radius: 5px;
      margin-top: 5px; /* Adjusted margin */
      margin-bottom: 20px; /* Space before next input/button */
      width: 0%; /* Default hidden */
      transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
      background-color: transparent; /* Initially transparent */
    }
    #passwordStrength.progress-very-weak { width: 25%; background-color: var(--error-color); }
    #passwordStrength.progress-weak { width: 50%; background-color: var(--error-color); }
    #passwordStrength.progress-medium { width: 75%; background-color: var(--warning-color); }
    #passwordStrength.progress-strong { width: 100%; background-color: var(--success-color); }
    #passwordStrength.progress-good { width: 100%; background-color: var(--info-color); } /* Using info for 'Good' */

  </style>
</head>
<body class="light-mode">
  <div class="reset-container">
    <h2>
      <i class="fas fa-key"></i>
      Create / Reset Password
    </h2>
    <form id="forgotPasswordForm">
      <div class="input-group">
        <label for="email">Email address</label>
        <input type="email" id="email" name="email" placeholder="name@example.com" required>
      </div>

      <div class="btn-container">
        <button type="button" id="sendOTP">
          <i class="fas fa-paper-plane"></i> Send OTP
        </button>
      </div>

      <div class="input-group" id="otpContainer" style="display:none;">
        <label for="otp">Enter OTP</label>
        <input type="text" id="otp" name="otp" placeholder="Enter OTP" maxlength="6">
      </div>

      <div id="passwordSection" style="display:none;">
        <div class="input-group">
          <label for="new-password">New Password</label>
          <div class="input-field-wrapper">
            <input type="password" id="new-password" name="newPassword" required>
            <span class="password-toggle" id="new-password-toggle">
                <i class="fa-solid fa-eye-slash"></i>
            </span>
          </div>
        </div>
        <div id="passwordStrength"></div>

        <div class="input-group">
          <label for="confirm-password">Confirm Password</label>
          <div class="input-field-wrapper">
            <input type="password" id="confirm-password" name="confirmPassword" required>
            <span class="password-toggle" id="confirm-password-toggle">
                <i class="fa-solid fa-eye-slash"></i>
            </span>
          </div>
        </div>
        <div class="btn-container">
          <button type="submit" id="setPasswordBtn">
            <i class="fa fa-key"></i> Save Password
          </button>
        </div>
      </div>

      <div class="spinner" id="processingSpinner"></div>
      <p id="message"></p>
    </form>
    
    <div class="btn-container">
      <a href="#" class="btn-link" id="backToLoginLink">
        <i class="fas fa-arrow-left"></i> Back to Login
      </a>
    </div>

  </div>

  <script>
    // --- Page Element References ---
    const sendOTPBtn = document.getElementById("sendOTP");
    const otpContainer = document.getElementById("otpContainer");
    const passwordSection = document.getElementById("passwordSection");
    const processingSpinner = document.getElementById("processingSpinner"); // Renamed for clarity
    const messageElement = document.getElementById("message"); // Unified message display
    const newPasswordField = document.getElementById("new-password");
    const confirmPasswordField = document.getElementById("confirm-password");
    const passwordStrengthBar = document.getElementById("passwordStrength");
    const setPasswordBtn = document.getElementById("setPasswordBtn");
    const emailInput = document.getElementById("email");
    const otpInput = document.getElementById("otp");

    // --- Helper Functions ---

    // Function to show/hide and style the message
    function showMessage(type, msg) {
      messageElement.textContent = msg;
      messageElement.classList.remove('success', 'error', 'warning'); // Clear previous classes
      messageElement.classList.add(type);
    }

    function clearMessage() {
      messageElement.textContent = '';
      messageElement.classList.remove('success', 'error', 'warning');
    }

    // Show spinner and disable buttons/inputs during processing
    function toggleProcessing(isProcessing) {
      processingSpinner.style.display = isProcessing ? "block" : "none";
      sendOTPBtn.disabled = isProcessing;
      setPasswordBtn.disabled = isProcessing;
      emailInput.disabled = isProcessing;
      newPasswordField.disabled = isProcessing;
      confirmPasswordField.disabled = isProcessing;
      otpInput.disabled = isProcessing;
    }

    // --- Password Toggle Logic (from reset_password.html) ---
    function setupPasswordToggle(passwordFieldId, toggleId) {
      const passwordField = document.getElementById(passwordFieldId);
      const passwordToggle = document.getElementById(toggleId);
      const eyeIcon = passwordToggle.querySelector('i');

      function updateVisibility() {
        if (passwordField.value.length > 0) {
          passwordToggle.style.display = 'inline-block';
        } else {
          passwordToggle.style.display = 'none';
          passwordField.type = 'password';
          eyeIcon.classList.remove('fa-eye');
          eyeIcon.classList.add('fa-eye-slash');
        }
      }

      passwordField.addEventListener('input', updateVisibility);
      window.addEventListener('load', updateVisibility); // For autofill

      passwordToggle.addEventListener('click', function() {
        const type = passwordField.type === 'password' ? 'text' : 'password';
        passwordField.type = type;
        eyeIcon.classList.toggle('fa-eye');
        eyeIcon.classList.toggle('fa-eye-slash');
        passwordField.focus();
      });
    }

    // --- Password Strength Evaluation (from forgot-password.html) ---
    function evaluatePasswordStrength(password) {
      let score = 0;
      if (password.length >= 8) score++; // Good length
      if (/[A-Z]/.test(password)) score++; // Uppercase
      if (/[a-z]/.test(password)) score++; // Lowercase
      if (/[0-9]/.test(password)) score++; // Numbers
      if (/[\W_]/.test(password)) score++; // Special characters (including underscore)

      // Update strength bar
      passwordStrengthBar.className = ""; // Reset classes
      if (password.length === 0) {
        passwordStrengthBar.style.width = '0%';
        passwordStrengthBar.style.backgroundColor = 'transparent';
        return { score: 0, text: "" };
      }

      switch(score) {
        case 5: 
          passwordStrengthBar.classList.add("progress-strong"); 
          return { score: 5, text: "Strong" };
        case 4: 
          passwordStrengthBar.classList.add("progress-good"); // Using 'Good' class
          return { score: 4, text: "Good" };
        case 3: 
          passwordStrengthBar.classList.add("progress-medium"); 
          return { score: 3, text: "Medium" };
        case 2: 
          passwordStrengthBar.classList.add("progress-weak"); 
          return { score: 2, text: "Weak" };
        default: 
          passwordStrengthBar.classList.add("progress-very-weak"); 
          return { score: 1, text: "Very Weak" }; // Score 0 or 1
      }
    }


    // --- Event Listeners and Main Logic ---
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize password toggles
      setupPasswordToggle('new-password', 'new-password-toggle');
      setupPasswordToggle('confirm-password', 'confirm-password-toggle');

      // Send OTP Button Click
      sendOTPBtn.addEventListener("click", () => {
        clearMessage();
        const email = emailInput.value.trim();
        if (!email) {
          showMessage("error", "Please enter your email.");
          return;
        }
        toggleProcessing(true);

        google.script.run
          .withSuccessHandler((res) => {
            toggleProcessing(false);
            if (res.success) {
              showMessage("success", "OTP sent! Please check your email.");
              otpContainer.style.display = "block";
              passwordSection.style.display = "none";
              sendOTPBtn.style.display = "none"; // Hide Send OTP button
              otpInput.focus();
            } else {
              showMessage("error", res.message || "Failed to send OTP.");
            }
          })
          .withFailureHandler((err) => {
            toggleProcessing(false);
            showMessage("error", "Error: " + err.message);
          })
          .sendOTP(email);
      });

      // Verify OTP on input (when length is 6)
      otpInput.addEventListener("input", () => {
        clearMessage();
        const otp = otpInput.value.trim();
        const email = emailInput.value.trim();
        if (otp.length === 6) {
          toggleProcessing(true);
          google.script.run
            .withSuccessHandler((res) => {
              toggleProcessing(false);
              if (res.valid) {
                showMessage("success", "OTP verified! You can now set your new password.");
                passwordSection.style.display = "block";
                otpContainer.style.display = "none";
                newPasswordField.focus();
              } else {
                showMessage("error", "Invalid or expired OTP.");
              }
            })
            .withFailureHandler((err) => {
              toggleProcessing(false);
              showMessage("error", "Error: " + err.message);
            })
            .verifyOTP(email, otp);
        }
      });

      // Password strength meter update
      newPasswordField.addEventListener("input", () => {
        evaluatePasswordStrength(newPasswordField.value);
      });

      // Form submission for password reset
      document.getElementById("forgotPasswordForm").addEventListener("submit", (e) => {
        e.preventDefault();
        clearMessage();

        const email = emailInput.value.trim();
        const newPassword = newPasswordField.value;
        const confirmPassword = confirmPasswordField.value;

        if (!newPassword || !confirmPassword) {
          showMessage("error", "Both password fields are required.");
          return;
        }
        if (newPassword !== confirmPassword) {
          showMessage("error", "Passwords do not match.");
          return;
        }
        
        const { score, text } = evaluatePasswordStrength(newPassword);
        if (score < 3) { // Require at least "Medium" strength
          showMessage("error", "Password is too " + text.toLowerCase() + ". Please make it stronger.");
          return;
        }

        toggleProcessing(true);
        google.script.run
          .withSuccessHandler((res) => {
            toggleProcessing(false);
            if (res.success) {
              showMessage("success", "Password has been reset successfully! Redirecting to login...");
              setTimeout(() => {
                google.script.run
                  .withSuccessHandler(function(url) {
                    window.top.location.replace(url);
                  })
                  .withFailureHandler(function(err) {
                    console.error("Failed to get login URL:", err);
                    showMessage("error", "Error redirecting to login page after reset.");
                  })
                  .getLoginUrl();
              }, 3000); // Redirect after 3 seconds
            } else {
              showMessage("error", res.message || "Failed to reset password.");
            }
          })
          .withFailureHandler((err) => {
            toggleProcessing(false);
            showMessage("error", "An unexpected error occurred: " + err.message);
          })
          .resetPassword(email, newPassword); // Call the backend function
      });

      // Back to Login Link
      document.getElementById("backToLoginLink").addEventListener("click", (e) => {
        e.preventDefault();
        google.script.run
          .withSuccessHandler(function(url) {
            window.top.location.replace(url);
          })
          .withFailureHandler(function(err) {
            console.error("Failed to get login URL:", err);
            showMessage("error", "Error redirecting to login page.");
          })
          .getLoginUrl();
      });
    });
  </script>
</body>
</html>
