<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS Variables for Theming (reused from dashboard.html/login.html) */
        :root {
            /* Light Mode Variables */
            --primary-accent-color: #4CAF50; /* Soft Green Accent */
            --primary-accent-color-hover: #45a049; /* Slightly darker on hover */
            --background-gradient-start: #e0e7ff; /* Lighter blue/violet */
            --background-gradient-end: #c3d9ff; /* Deeper blue/violet */
            --text-color-primary: #333;
            --text-color-secondary: #666;
            --card-bg-color: rgba(240, 240, 240, 0.8); /* Slightly transparent white for glass effect */
            --input-bg-color: #e8e8e8;
            --input-bg-focus-color: #f5f5f5;
            --button-bg-color: #e0e0e0;
            --error-color: #e74c3c; /* Red */
            --success-color: #27ae60; /* Green */
            --warning-color: #f39c12; /* Added for password strength bar */
            --info-color: #3498db; /* Added for password strength bar ('Good' strength) */

            /* Neumorphic Shadows (Light Mode) */
            --neumorphic-shadow-light: 10px 10px 20px rgba(0, 0, 0, 0.1), -10px -10px 20px rgba(255, 255, 255, 0.7);
            --neumorphic-shadow-raised: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;
            --neumorphic-shadow-hover: 8px 8px 15px rgba(0, 0, 0, 0.15), -8px -8px 15px rgba(255, 255, 255, 0.85);
            --neumorphic-shadow-inset: inset 2px 2px 5px rgba(0,0,0,0.1), inset -2px -2px 5px rgba(255,255,255,0.7);

            /* Neumorphic Input Inset (Light Mode) */
            --neumorphic-input-inset-shadow: inset 2px 2px 5px rgba(0,0,0,0.1), inset -2px -2px 5px rgba(255,255,255,0.7);
            --neumorphic-input-focus-shadow: inset 3px 3px 7px rgba(0,0,0,0.15), inset -3px -3px 7px rgba(255,255,255,0.85);

            /* Glassmorphism */
            --glass-filter: blur(10px);
            --glass-border: 1px solid rgba(255, 255, 255, 0.18); /* Subtle border for glass effect */

            /* Border Radii */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 24px;

            /* Sidebar & Layout */
            --sidebar-width: 250px;
            --sidebar-width-collapsed: 80px;

            /* Scrollbar */
            --scrollbar-thumb: var(--primary-accent-color);
            --scrollbar-track: rgba(0, 0, 0, 0.05);
        }

        /* Dark Mode Variables - applies when body has 'dark-mode' class */
        body.dark-mode {
            --primary-accent-color: #6a0dad; /* Violet Accent */
            --primary-accent-color-hover: #7b00ea; /* Lighter violet */
            --background-gradient-start: #2a293a; /* Darker grey-violet */
            --background-gradient-end: #3b3a4e; /* Lighter grey-violet */
            --text-color-primary: #f0f0f0;
            --text-color-secondary: #b0b0b0;
            --card-bg-color: rgba(32, 33, 36, 0.8); /* Transparent dark grey */
            --input-bg-color: #2c2d30;
            --input-bg-focus-color: #38393c;
            --button-bg-color: #383838;
            --error-color: #ff6b6b; /* Red */
            --success-color: #2ecc71; /* Green */
            --warning-color: #f1c40f; /* For password strength bar */
            --info-color: #9b59b6; /* For password strength bar ('Good' strength) */

            /* Neumorphic Shadows (Dark Mode) */
            --neumorphic-shadow-light: 10px 10px 20px rgba(0, 0, 0, 0.5), -10px -10px 20px rgba(60, 60, 60, 0.5);
            --neumorphic-shadow-raised: 5px 5px 10px #222, -5px -5px 10px #444;
            --neumorphic-shadow-hover: 8px 8px 15px rgba(0, 0, 0, 0.6), -8px -8px 15px rgba(70, 70, 70, 0.6);
            --neumorphic-shadow-inset: inset 2px 2px 5px rgba(0,0,0,0.5), inset -2px -2px 5px rgba(60,60,60,0.5);

            /* Neumorphic Input Inset (Dark Mode) */
            --neumorphic-input-inset-shadow: inset 2px 2px 5px rgba(0,0,0,0.5), inset -2px -2px 5px rgba(60,60,60,0.5);
            --neumorphic-input-focus-shadow: inset 3px 3px 7px rgba(0,0,0,0.6), inset -3px -3px 7px rgba(70,70,70,0.6);

            /* Glassmorphism for Dark Mode */
            --glass-border: 1px solid rgba(255, 255, 255, 0.05); /* Lighter border for contrast */

            /* Scrollbar */
            --scrollbar-thumb: var(--primary-accent-color);
            --scrollbar-track: rgba(255, 255, 255, 0.05);
        }
        /* End of CSS Variables */

        /* Global Base Styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color-primary);
            background: linear-gradient(to right bottom, var(--background-gradient-start), var(--background-gradient-end));
            transition: background 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex; /* For basic layout */
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll due to sidebar transitions */
        }

        /* Scrollbar Styling */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        body::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: var(--border-radius-md);
            border: 2px solid var(--scrollbar-track);
        }

        /* Layout Container */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width); /* Prevent shrinking below this */
            background: var(--card-bg-color);
            box-shadow: var(--neumorphic-shadow-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: sticky;
            top: 0;
            height: 100vh; /* Make it stick for full height */
            overflow-y: auto;
            backdrop-filter: var(--glass-filter);
            border-right: var(--glass-border);
        }
        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
            min-width: var(--sidebar-width-collapsed);
            padding: 20px 0; /* Adjust padding for collapsed state */
            align-items: center; /* Center items when collapsed */
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-left: 10px;
            padding-right: 10px;
        }
        .sidebar-header.collapsed {
            justify-content: center;
            padding: 0;
        }

        .sidebar-header .logo-text {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary-accent-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-header.collapsed .logo-text {
            display: none; /* Hide text when collapsed */
        }
        .sidebar-toggle {
            background: var(--button-bg-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow-raised);
            color: var(--text-color-secondary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .sidebar-toggle:hover {
            box-shadow: var(--neumorphic-shadow-hover);
            transform: scale(1.05);
        }
        .sidebar-toggle:active {
            box-shadow: var(--neumorphic-shadow-inset);
            transform: scale(0.95);
        }
        .sidebar.collapsed .sidebar-toggle {
            transform: rotate(180deg); /* Rotate arrow when collapsed */
        }

        .sidebar-menu {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px; /* Space for scrollbar */
        }
        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu li {
            margin-bottom: 10px;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: var(--text-color-primary);
            border-radius: var(--border-radius-md);
            transition: all 0.2s ease;
            font-weight: 500;
            box-shadow: var(--neumorphic-shadow-raised); /* Default raised look */
        }
        .sidebar-menu a:hover {
            box-shadow: var(--neumorphic-shadow-hover); /* Hover effect */
            transform: translateY(-2px);
            color: var(--primary-accent-color);
        }
        .sidebar-menu a.active {
            background: var(--primary-accent-color);
            color: white;
            box-shadow: var(--neumorphic-shadow-inset); /* Inset for active */
            transform: translateY(0);
        }
        .sidebar-menu a i {
            margin-right: 15px;
            font-size: 1.2em;
            width: 25px; /* Fixed width for icons */
            text-align: center;
        }
        .sidebar.collapsed .sidebar-menu a {
            justify-content: center;
            padding: 12px 0;
            width: 50px; /* Fixed width for icon only */
            margin: 0 auto; /* Center item */
            box-shadow: none; /* No shadow when collapsed */
        }
        .sidebar.collapsed .sidebar-menu a .menu-text {
            display: none; /* Hide text when collapsed */
        }
        .sidebar.collapsed .sidebar-menu a i {
            margin-right: 0;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Top Bar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg-color);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--neumorphic-shadow-light);
            padding: 15px 30px;
            backdrop-filter: var(--glass-filter);
            border: var(--glass-border);
            position: sticky;
            top: 30px; /* Stay below the top padding */
            z-index: 100;
        }

        .topbar .company-info {
            display: flex;
            align-items: center;
        }
        .topbar .company-logo {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-md);
            margin-right: 15px;
            box-shadow: var(--neumorphic-shadow-raised);
        }
        .topbar .company-name {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-color-primary);
        }

        .topbar .user-profile-widget {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            background: var(--button-bg-color);
            padding: 8px 15px;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--neumorphic-shadow-raised);
            transition: all 0.2s ease;
        }
        .topbar .user-profile-widget:hover {
            box-shadow: var(--neumorphic-shadow-hover);
            transform: translateY(-1px);
        }
        .topbar .user-profile-widget.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .profile-dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--card-bg-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--neumorphic-shadow-light);
            min-width: 200px;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            padding: 5px 0;
            backdrop-filter: var(--glass-filter);
            border: var(--glass-border);
        }
        .profile-dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .profile-dropdown-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .profile-dropdown-menu li a,
        .profile-dropdown-menu li button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
            text-align: left;
            color: var(--text-color-primary);
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: background 0.1s ease, color 0.1s ease;
        }
        .profile-dropdown-menu li a:hover,
        .profile-dropdown-menu li button:hover {
            background: rgba(var(--primary-accent-color), 0.1);
            color: var(--primary-accent-color);
        }
        .profile-dropdown-menu li a i,
        .profile-dropdown-menu li button i {
            margin-right: 10px;
            width: 20px; /* Fixed width for icon alignment */
            text-align: center;
        }
        .profile-dropdown-menu .divider {
            height: 1px;
            background: var(--text-color-secondary);
            opacity: 0.2;
            margin: 5px 0;
        }

        /* Notification and Dark Mode Toggle */
        .topbar .utility-icons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .topbar .utility-icons button {
            background: var(--button-bg-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--neumorphic-shadow-raised);
            color: var(--text-color-secondary);
            font-size: 1.1em;
            transition: all 0.2s ease;
            position: relative; /* For notification badge */
        }
        .topbar .utility-icons button:hover {
            box-shadow: var(--neumorphic-shadow-hover);
            transform: translateY(-1px);
            color: var(--primary-accent-color);
        }
        .topbar .utility-icons button:active {
            box-shadow: var(--neumorphic-shadow-inset);
            transform: translateY(0);
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { transform: scale(0.8); opacity: 0.7; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Content Layout */
        .content-area-main {
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
            opacity: 0; /* Hidden initially, JS controls visibility */
            transition: opacity 0.5s ease;
            margin-top: 20px; /* Space below top bar */
        }
        .content-area-main.visible {
            opacity: 1;
        }

        /* Common Card Styles */
        .card {
            background: var(--card-bg-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--neumorphic-shadow-raised); /* Use raised for regular cards */
            padding: 25px;
            backdrop-filter: var(--glass-filter);
            border: var(--glass-border);
            transition: all 0.3s ease;
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-color-primary);
            font-size: 1.4em;
            font-weight: 600;
        }

        /* Input Group Styles (reused from login) */
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-color-secondary);
            font-weight: 500;
            text-transform: uppercase;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 1.1em;
            background: var(--input-bg-color);
            color: var(--text-color-primary);
            box-shadow: var(--neumorphic-input-inset-shadow);
            outline: none;
            transition: box-shadow 0.2s ease, background 0.2s ease;
            box-sizing: border-box; /* Include padding in width */
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            box-shadow: var(--neumorphic-input-focus-shadow);
            background: var(--input-bg-focus-color);
        }
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
            padding-top: 15px;
        }

        /* Button Styles (reused from login) */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-lg);
            font-size: 1.1em;
            font-weight: 700;
            color: white; /* Default to white text on primary button */
            background: var(--primary-accent-color);
            box-shadow: var(--neumorphic-shadow-raised);
            cursor: pointer;
            min-width: 150px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none; /* For link-like buttons */
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--neumorphic-shadow-hover);
            background: var(--primary-accent-color-hover);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--neumorphic-shadow-inset);
        }
        .btn:disabled, .btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--neumorphic-shadow-inner);
        }

        .btn-secondary {
            background: var(--button-bg-color);
            color: var(--text-color-primary); /* Dark text for secondary buttons */
        }
        .btn-secondary:hover {
            background: var(--input-bg-focus-color);
            color: var(--primary-accent-color);
        }
        .btn-danger {
            background: var(--error-color);
            color: white;
        }
        .btn-danger:hover {
            background: #D0392C; /* Slightly darker red */
        }
        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        /* Messages & Spinners */
        .message {
            margin-top: 15px;
            font-size: 0.95em;
            font-weight: 500;
            text-align: center;
        }
        .message.error { color: var(--error-color); }
        .message.success { color: var(--success-color); }
        .message.info { color: var(--info-color); }
        .spinner {
            margin-top: 20px;
            border: 4px solid var(--text-color-secondary);
            border-left-color: var(--primary-accent-color);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: auto;
            margin-right: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard Specific Layouts */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }
        .dashboard-grid .card {
            padding: 20px;
        }

        /* Tables & Lists */
        .data-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-md);
            box-shadow: var(--neumorphic-shadow-inset);
            background: var(--input-bg-color);
            padding: 15px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            color: var(--text-color-primary);
            white-space: nowrap; /* Prevent wrapping in table cells */
        }
        .data-table th {
            background: var(--primary-accent-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 50; /* Keep header visible on scroll */
        }
        .data-table tr:nth-child(even) {
            background: rgba(0,0,0,0.02);
        }
        .data-table tbody tr:hover {
            background: rgba(var(--primary-accent-color), 0.1);
        }
        .data-table .status-cell {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
        }
        .status-cell.Pending { background-color: var(--warning-color); color: white; }
        .status-cell.Approved { background-color: var(--success-color); color: white; }
        .status-cell.Rejected { background-color: var(--error-color); color: white; }
        .status-cell.Submitted { background-color: var(--info-color); color: white; }
        .status-cell.InProgress { background-color: var(--info-color); color: white; }
        .status-cell.Active { background-color: var(--success-color); color: white; }
        .status-cell.Inactive { background-color: var(--error-color); color: white; }
        .status-cell.Present { background-color: var(--success-color); color: white; } /* specific for attendance */
        .status-cell.Absent { background-color: var(--error-color); color: white; } /* specific for attendance */
        .status-cell.CheckedIn { background-color: var(--info-color); color: white; } /* specific for attendance */
        .status-cell.Late { background-color: var(--warning-color); color: white; } /* specific for attendance */


        /* Form Grid Layout (for employee management) */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
            .form-grid .full-width {
                grid-column: span 2;
            }
        }
        .input-group.inline-buttons {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .input-group.inline-buttons input {
            flex-grow: 1;
        }
        .input-group.inline-buttons .btn {
            min-width: fit-content;
            padding: 10px 15px;
            font-size: 0.9em;
            height: 48px; /* Match input height */
        }

        /* Announcements */
        .announcement-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .announcement-item {
            padding: 15px;
            background: var(--button-bg-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--neumorphic-shadow-raised);
            position: relative;
        }
        .announcement-item h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary-accent-color);
        }
        .announcement-item p {
            font-size: 0.9em;
            color: var(--text-color-primary);
            margin-bottom: 10px;
        }
        .announcement-item .meta {
            font-size: 0.8em;
            color: var(--text-color-secondary);
            text-align: right;
        }
        .announcement-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 1.1em;
            cursor: pointer;
            z-index: 10;
        }

        /* Policy List */
        .policy-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .policy-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--button-bg-color);
            padding: 12px 15px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--neumorphic-shadow-raised);
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--text-color-primary);
            position: relative;
        }
        .policy-list-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--neumorphic-shadow-hover);
            color: var(--primary-accent-color);
        }
        .policy-list-item h4 {
            margin: 0;
            font-size: 1em;
            font-weight: 600;
        }
        .policy-list-item i {
            font-size: 1.1em;
        }
        .policy-list-item .policy-actions {
            display: flex;
            gap: 5px;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--button-bg-color); /* To hide text behind it */
            padding-left: 10px;
            border-radius: var(--border-radius-md);
        }
         .policy-list-item .policy-actions button {
            padding: 5px;
            background: none;
            border: none;
            font-size: 1em;
            cursor: pointer;
            color: var(--text-color-secondary);
            transition: color 0.2s ease;
         }
         .policy-list-item .policy-actions button:hover {
            color: var(--primary-accent-color);
         }
         .policy-list-item .policy-actions button.delete-btn:hover {
            color: var(--error-color);
         }


        /* Overlay for Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
        }
        .modal-content {
            background: var(--card-bg-color);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--neumorphic-shadow-light);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: fadeInScale 0.3s ease-out;
            backdrop-filter: var(--glass-filter);
            border: var(--glass-border);
        }
        .close-button {
            color: var(--text-color-secondary);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover, .close-button:focus {
            color: var(--error-color);
            text-decoration: none;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Password Toggle Specific Styles */
        .input-field-wrapper {
            position: relative;
            width: 100%;
            display: block;
        }
        .input-field-wrapper input {
            padding-right: 45px;
            box-sizing: border-box;
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-color-secondary);
            font-size: 0.9em;
            transition: color 0.2s ease;
            display: none;
            z-index: 2;
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .sidebar {
                width: var(--sidebar-width-collapsed);
                min-width: var(--sidebar-width-collapsed);
                padding: 20px 0;
                position: fixed; /* Fixed position for mobile sidebar */
                height: 100%;
                z-index: 1000;
                left: 0;
                transform: translateX(-100%); /* Initially hide on small screens */
            }
            .sidebar.collapsed { /* This would be the 'open' state on mobile */
                transform: translateX(0);
            }
            .main-content {
                margin-left: var(--sidebar-width-collapsed); /* Provide space for the static sidebar */
                width: calc(100% - var(--sidebar-width-collapsed));
            }
            .sidebar-toggle {
                box-shadow: none; /* No shadow on fixed toggle */
                background: none;
                color: var(--primary-accent-color);
            }
            .sidebar.collapsed .sidebar-toggle {
                position: absolute;
                right: -40px; /* Position toggle button outside sidebar */
                top: 20px;
                transform: rotate(0deg); /* Reset rotation */
                background: var(--card-bg-color);
                border-radius: 50%;
                box-shadow: var(--neumorphic-shadow-raised);
            }
            .topbar {
                border-radius: var(--border-radius-lg);
                padding: 10px 20px;
            }
            .topbar .company-name {
                font-size: 1.2em;
            }
            .topbar .user-profile-widget .username {
                display: none; /* Hide username on small screens */
            }
        }
        @media (max-width: 767px) {
            .dashboard-container {
                flex-direction: column;
            }
            .sidebar {
                height: auto; /* Allow height to adapt */
                position: relative;
                width: 100%;
                transform: translateX(0) !important; /* Always visible to start */
                padding: 20px;
                min-width: unset;
            }
            .sidebar.collapsed { /* This collapsed state makes sense on desktop only */
                width: 100%; /* Make full width on collapse */
                justify-content: flex-start;
                align-items: flex-start;
            }
            .sidebar-header {
                justify-content: flex-start;
                padding-left: 0;
            }
            .sidebar-toggle {
                display: none; /* Hide toggle button on very small screens */
            }
            .sidebar-menu a .menu-text {
                display: inline !important; /* Always show text on small screens */
            }
            .sidebar-menu a i {
                margin-right: 15px;
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            .topbar {
                width: auto;
                top: 0; /* No sticky on small screen */
                border-radius: 0;
            }
            .content-area-main {
                padding: 20px;
                margin-top: 0;
            }
            .dashboard-grid, .form-grid {
                grid-template-columns: 1fr;
            }
            .form-grid .full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body class="light-mode">
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header" id="sidebar-header">
                <span class="logo-text">NepHR</span>
                <button class="sidebar-toggle" id="sidebar-toggle"><i class="fas fa-chevron-left"></i></button>
            </div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#" class="nav-link active" data-target="home"><i class="fas fa-home"></i><span class="menu-text">Admin Dashboard</span></a></li>
                    <li><a href="#" class="nav-link" data-target="employees"><i class="fas fa-users"></i><span class="menu-text">Employee Mgmt.</span></a></li>
                    <li><a href="#" class="nav-link" data-target="attendance-admin"><i class="fas fa-calendar-alt"></i><span class="menu-text">Attendance Mgmt.</span></a></li>
                    <li><a href="#" class="nav-link" data-target="tasks-admin"><i class="fas fa-clipboard-list"></i><span class="menu-text">Task Mgmt.</span></a></li>
                    <li><a href="#" class="nav-link" data-target="leaves-admin"><i class="fas fa-calendar-check"></i><span class="menu-text">Leave Mgmt.</span></a></li>
                    <li><a href="#" class="nav-link" data-target="announcements-admin"><i class="fas fa-bullhorn"></i><span class="menu-text">Announcements</span></a></li>
                    <li><a href="#" class="nav-link" data-target="policies-admin"><i class="fas fa-file-alt"></i><span class="menu-text">Policies Mgmt.</span></a></li>
                    <li><a href="#" class="nav-link" data-target="payslips-admin"><i class="fas fa-money-bill"></i><span class="menu-text">Payslips Mgmt.</span></a></li>
                    <li><a href="#" class="nav-link" data-target="config"><i class="fas fa-tools"></i><span class="menu-text">System Config</span></a></li>
                    <li><a href="#" class="nav-link" data-target="reports-admin"><i class="fas fa-chart-bar"></i><span class="menu-text">Reports</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <p id="system-date-time" style="font-size: 0.8em; text-align: center; color: var(--text-color-secondary);"></p>
            </div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="company-info">
                    <img id="topbar-company-logo" src="https://via.placeholder.com/40x40?text=Logo" alt="NepHR Logo" class="company-logo">
                    <span class="company-name">NepHR Admin</span>
                </div>
                <div class="utility-icons">
                    <button id="dark-mode-toggle" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-profile-widget" id="user-profile-widget">
                        <img id="topbar-profile-pic" src="https://via.placeholder.com/35x35?text=A" alt="Admin Profile" class="profile-pic">
                        <span id="topbar-username" class="username">Admin</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                        <div class="profile-dropdown-menu" id="profile-dropdown-menu">
                            <ul>
                                <li><button id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area-main" id="content-area-main">
                <!-- --- Admin Dashboard Home Section (Overview) --- -->
                <section id="home-section" class="content-section card visible">
                    <h3>Admin Dashboard Overview</h3>
                    <div class="dashboard-grid">
                        <div class="card">
                            <h4>Total Employees</h4>
                            <p id="total-employees-count" style="font-size: 2em; font-weight: 700; color: var(--primary-accent-color);">0</p>
                            <p id="active-inactive-employees" style="font-size: 0.9em; color: var(--text-color-secondary);">Active: 0, Inactive: 0</p>
                        </div>
                        <div class="card">
                            <h4>Today's Attendance Summary</h4>
                            <p id="today-present" style="color: var(--success-color);">Present: 0</p>
                            <p id="today-late" style="color: var(--warning-color);">Late: 0</p>
                            <p id="today-absent" style="color: var(--error-color);">Absent: 0</p>
                        </div>
                        <div class="card">
                            <h4>Pending Leave Requests</h4>
                            <p id="pending-leaves-count" style="font-size: 2em; font-weight: 700; color: var(--warning-color);">0</p>
                        </div>
                        <div class="card">
                            <h4>Tasks Overview</h4>
                            <p id="open-tasks" style="color: var(--info-color);">Open: 0</p>
                            <p id="submitted-tasks" style="color: var(--success-color);">Submitted: 0</p>
                        </div>
                    </div>
                </section>

                <!-- --- Employee Management Section --- -->
                <section id="employees-section" class="content-section card" style="display:none;">
                    <h3>Employee Management</h3>
                    <div class="btn-container">
                        <button class="btn" id="add-employee-btn"><i class="fas fa-plus"></i> Add New Employee</button>
                    </div>
                    <div id="employees-list-container" class="data-table-container">
                        <p class="message info">Loading employees...</p>
                    </div>
                    <p id="employees-message" class="message"></p>
                    <div class="spinner" id="employees-spinner"></div>
                </section>

                <!-- --- Attendance Management Section (Admin) --- -->
                <section id="attendance-admin-section" class="content-section card" style="display:none;">
                    <h3>Attendance Management</h3>
                    <div class="input-group inline-buttons">
                        <input type="date" id="attendance-date-filter">
                        <button class="btn btn-secondary" id="filter-attendance-btn"><i class="fas fa-search"></i> Filter</button>
                    </div>
                    <div id="admin-attendance-summary-container" class="data-table-container">
                        <p class="message info">Select a date to view attendance summary.</p>
                    </div>
                    <p id="attendance-admin-message" class="message"></p>
                    <div class="spinner" id="attendance-admin-spinner"></div>
                </section>

                <!-- --- Task Management Section (Admin) --- -->
                <section id="tasks-admin-section" class="content-section card" style="display:none;">
                    <h3>Task Management</h3>
                    <div class="btn-container">
                        <button class="btn" id="assign-task-btn"><i class="fas fa-plus"></i> Assign New Task</button>
                    </div>
                    <div class="input-group">
                        <label for="task-admin-filter">Filter Tasks:</label>
                        <select id="task-admin-filter">
                            <option value="pending">Pending</option>
                            <option value="in progress">In Progress</option>
                            <option value="submitted">Submitted for Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="all">All Tasks</option>
                        </select>
                    </div>
                    <div id="tasks-admin-list-container" class="data-table-container">
                        <p class="message info">Loading tasks...</p>
                    </div>
                    <p id="tasks-admin-message" class="message"></p>
                    <div class="spinner" id="tasks-admin-spinner"></div>
                </section>

                <!-- --- Leave Management Section (Admin) --- -->
                <section id="leaves-admin-section" class="content-section card" style="display:none;">
                    <h3>Leave Applications Review</h3>
                    <div class="input-group">
                        <label for="leave-admin-filter">Filter Applications:</label>
                        <select id="leave-admin-filter">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="all">All Applications</option>
                        </select>
                    </div>
                    <div id="leaves-admin-list-container" class="data-table-container">
                        <p class="message info">Loading leave applications...</p>
                    </div>
                    <p id="leaves-admin-message" class="message"></p>
                    <div class="spinner" id="leaves-admin-spinner"></div>
                </section>

                <!-- --- Announcements Management Section --- -->
                <section id="announcements-admin-section" class="content-section card" style="display:none;">
                    <h3>Announcements Management</h3>
                    <form id="create-announcement-form">
                        <div class="input-group">
                            <label for="announcement-title">Title</label>
                            <input type="text" id="announcement-title" required>
                        </div>
                        <div class="input-group">
                            <label for="announcement-content">Content</label>
                            <textarea id="announcement-content" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="announcement-valid-until">Valid Until (Optional)</label>
                            <input type="date" id="announcement-valid-until">
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn"><i class="fas fa-plus"></i> Create Announcement</button>
                        </div>
                    </form>
                    <p id="create-announcement-message" class="message"></p>
                    <div class="spinner" id="create-announcement-spinner"></div>

                    <h3 style="margin-top: 40px;">Existing Announcements</h3>
                    <div id="existing-announcements-list" class="announcement-list">
                        <p class="message info">No announcements created yet.</p>
                    </div>
                    <p id="existing-announcements-message" class="message"></p>
                    <div class="spinner" id="existing-announcements-spinner"></div>
                </section>

                <!-- --- Policy Management Section --- -->
                <section id="policies-admin-section" class="content-section card" style="display:none;">
                    <h3>Policy Management</h3>
                    <form id="policy-form">
                         <input type="hidden" id="policy-id">
                        <div class="input-group">
                            <label for="policy-title">Policy Title</label>
                            <input type="text" id="policy-title" required>
                        </div>
                        <div class="input-group">
                            <label for="policy-description">Description</label>
                            <textarea id="policy-description" rows="3"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="policy-document-url">Document URL (Google Drive Link)</label>
                            <input type="url" id="policy-document-url">
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn" id="save-policy-btn"><i class="fas fa-save"></i> Save Policy</button>
                            <button type="button" class="btn btn-secondary" id="reset-policy-form-btn"><i class="fas fa-times"></i> Clear Form</button>
                        </div>
                    </form>
                     <p id="policy-message" class="message"></p>
                    <div class="spinner" id="policy-spinner"></div>

                    <h3 style="margin-top: 40px;">Existing Policies</h3>
                    <div id="existing-policies-list" class="policy-list">
                        <p class="message info">No policies created yet.</p>
                    </div>
                    <p id="existing-policies-message" class="message"></p>
                    <div class="spinner" id="existing-policies-spinner"></div>
                </section>

                <!-- --- Payslip Management Section --- -->
                <section id="payslips-admin-section" class="content-section card" style="display:none;">
                    <h3>Payslip Upload</h3>
                    <form id="payslip-upload-form">
                        <div class="input-group">
                            <label for="payslip-username">Employee Username</label>
                            <input type="text" id="payslip-username" required placeholder="e.g., john.doe">
                        </div>
                        <div class="input-group">
                            <label for="payslip-month-year">Month/Year (e.g., Jan 2024)</label>
                            <input type="text" id="payslip-month-year" required placeholder="e.g., January 2024">
                        </div>
                        <div class="input-group">
                            <label for="payslip-file">Payslip Document (PDF)</label>
                            <input type="file" id="payslip-file" accept=".pdf" required>
                        </div>
                         <div class="input-group">
                            <label for="payslip-comment">Comment (Optional)</label>
                            <textarea id="payslip-comment" rows="2"></textarea>
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn"><i class="fas fa-cloud-upload-alt"></i> Upload Payslip</button>
                        </div>
                    </form>
                    <p id="payslip-admin-message" class="message"></p>
                    <div class="spinner" id="payslip-admin-spinner"></div>
                </section>

                <!-- --- System Configuration Section --- -->
                <section id="config-section" class="content-section card" style="display:none;">
                    <h3>System Configuration</h3>
                    <form id="banner-upload-form">
                        <h4>Company Banner</h4>
                        <img id="current-banner-preview" src="https://via.placeholder.com/300x80?text=Current+Banner" alt="Current Banner" style="max-width: 100%; height: auto; display: block; margin-bottom: 15px; border-radius: var(--border-radius-md); box-shadow: var(--neumorphic-shadow-raised);">
                        <div class="input-group">
                            <label for="banner-file-input">Select Banner Image</label>
                            <input type="file" id="banner-file-input" accept="image/*" required>
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn"><i class="fas fa-image"></i> Upload Banner</button>
                        </div>
                    </form>
                    <p id="banner-message" class="message"></p>
                    <div class="spinner" id="banner-spinner"></div>

                    <form id="accent-color-form" style="margin-top: 40px;">
                        <h4>Accent Color</h4>
                        <div class="input-group">
                            <label for="accent-color-input">Accent Color (Hex Code)</label>
                            <input type="color" id="accent-color-input" value="#4CAF50">
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn"><i class="fas fa-tint"></i> Update Accent Color</button>
                        </div>
                    </form>
                    <p id="accent-color-message" class="message"></p>
                    <div class="spinner" id="accent-color-spinner"></div>
                </section>

                <!-- --- Reports Section (Admin - Simplified) --- -->
                <section id="reports-admin-section" class="content-section card" style="display:none;">
                    <h3>Admin Reports</h3>
                    <p class="message info">This section provides tools to generate various reports.</p>
                     <div class="btn-container">
                        <button class="btn btn-secondary" onclick="alert('Generate Detailed Attendance Report (Mock)')"><i class="fas fa-file-excel"></i> Daily Attendance Summary</button>
                        <button class="btn btn-secondary" onclick="alert('Generate All Tasks Report (Mock)')"><i class="fas fa-file-alt"></i> All Tasks Report</button>
                        <button class="btn btn-secondary" onclick="alert('Generate Leave Applications Report (Mock)')"><i class="fas fa-file-pdf"></i> Leave Applications Report</button>
                        <button class="btn btn-secondary" onclick="alert('Generate Employee List Export (Mock)')"><i class="fas fa-file-csv"></i> Employee List Export</button>
                    </div>
                    <p id="reports-admin-message" class="message"></p>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="employee-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="close-employee-modal">&times;</span>
            <h3 id="employee-modal-title">Add/Edit Employee</h3>
            <form id="employee-form" class="form-grid">
                <input type="hidden" id="employee-form-original-username">
                <div class="input-group">
                    <label for="emp-username">Username</label>
                    <input type="text" id="emp-username" required>
                </div>
                <div class="input-group">
                    <label for="emp-employeeid">Employee ID</label>
                    <input type="text" id="emp-employeeid">
                </div>
                <div class="input-group full-width">
                    <label for="emp-fullname">Full Name</label>
                    <input type="text" id="emp-fullname" required>
                </div>
                <div class="input-group">
                    <label for="emp-email">Email</label>
                    <input type="email" id="emp-email" required>
                </div>
                <div class="input-group">
                    <label for="emp-phonenumber">Phone Number</label>
                    <input type="tel" id="emp-phonenumber">
                </div>
                <div class="input-group">
                    <label for="emp-department">Department</label>
                    <input type="text" id="emp-department">
                </div>
                <div class="input-group">
                    <label for="emp-role">Role</label>
                    <select id="emp-role">
                        <option value="Employee">Employee</option>
                        <option value="Manager">Manager</option>
                        <option value="HR">HR</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="emp-joindate">Join Date</label>
                    <input type="date" id="emp-joindate">
                </div>
                 <div class="input-group">
                    <label for="emp-status">Status</label>
                   <select id="emp-status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                   </select>
                </div>
                <div class="btn-container full-width">
                    <button type="submit" class="btn" id="save-employee-btn"><i class="fas fa-save"></i> Save Employee</button>
                </div>
            </form>
            <p id="employee-modal-message" class="message"></p>
            <div class="spinner" id="employee-modal-spinner"></div>
        </div>
    </div>

    <div id="assign-task-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="close-assign-task-modal">&times;</span>
            <h3>Assign New Task</h3>
            <form id="assign-task-form" class="form-grid">
                <div class="input-group">
                    <label for="task-assign-to">Assign To Username</label>
                    <input type="text" id="task-assign-to" required>
                </div>
                 <div class="input-group">
                    <label for="task-due-date">Due Date</label>
                    <input type="date" id="task-due-date" required>
                </div>
                <div class="input-group full-width">
                    <label for="task-title">Task Title</label>
                    <input type="text" id="task-title" required>
                </div>
                <div class="input-group full-width">
                    <label for="task-description">Description</label>
                    <textarea id="task-description" rows="4"></textarea>
                </div>
                <div class="input-group">
                    <label for="task-type">Type</label>
                    <select id="task-type">
                        <option value="Daily">Daily</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="task-priority">Priority</label>
                    <select id="task-priority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div class="btn-container full-width">
                    <button type="submit" class="btn"><i class="fas fa-plus"></i> Assign Task</button>
                </div>
            </form>
            <p id="assign-task-modal-message" class="message"></p>
            <div class="spinner" id="assign-task-modal-spinner"></div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script>
    <script>
        // --- Global Variables & Constants (Client-side) ---
        const SESSION_COOKIE_NAME = 'nepHR_session';
        let currentSessionId = '';
        let currentUserData = {}; // Stores username, role etc.

        // --- Helper Functions ---

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999; Path=/;';
        }

        function showSpinner(spinnerId) { document.getElementById(spinnerId).style.display = 'block'; }
        function hideSpinner(spinnerId) { document.getElementById(spinnerId).style.display = 'none'; }
        function showMessage(msgId, type, message) {
            const el = document.getElementById(msgId);
            if (el) {
                el.textContent = message;
                el.className = `message ${type}`;
            }
        }
        function clearMessage(msgId) {
            const el = document.getElementById(msgId);
            if (el) {
                el.textContent = '';
                el.className = 'message';
            }
        }
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- Core UI & Navigation Logic ---

        function setupPasswordToggle(passwordFieldId, toggleId) {
            const passwordField = document.getElementById(passwordFieldId);
            const passwordToggle = document.getElementById(toggleId);
            const eyeIcon = passwordToggle ? passwordToggle.querySelector('i') : null;

            function updateVisibility() {
                if (!passwordField || !passwordToggle || !eyeIcon) return;
                if (passwordField.value.length > 0) {
                    passwordToggle.style.display = 'inline-block';
                } else {
                    passwordToggle.style.display = 'none';
                    passwordField.type = 'password';
                    eyeIcon.classList.remove('fa-eye');
                    eyeIcon.classList.add('fa-eye-slash');
                }
            }

            if (passwordField && passwordToggle) {
                passwordField.addEventListener('input', updateVisibility);
                // Use setTimeout to ensure autofilled values are present
                setTimeout(updateVisibility, 100);

                passwordToggle.addEventListener('click', function() {
                    const type = passwordField.type === 'password' ? 'text' : 'password';
                    passwordField.type = type;
                    this.querySelector('i').classList.toggle('fa-eye');
                    this.querySelector('i').classList.toggle('fa-eye-slash');
                    passwordField.focus();
                });
            }
        }


        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('visible');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.style.display = 'block';
                setTimeout(() => activeSection.classList.add('visible'), 50);
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.nav-link[data-target="${sectionId.replace('-section', '')}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                if (document.getElementById('sidebar').classList.contains('collapsed')) {
                    document.getElementById('sidebar').classList.remove('collapsed');
                }
            }
        }

        function initializeAdminDashboard() {
            currentSessionId = getCookie(SESSION_COOKIE_NAME);
            if (!currentSessionId) {
                window.top.location.href = '<?= ScriptApp.getService().getUrl(); ?>'; // Redirect to login
                return;
            }

            // Set current date for attendance filter
            document.getElementById('attendance-date-filter').valueAsDate = new Date();

            // Add event listeners for navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.dataset.target + '-section';
                    showSection(targetSection);
                    loadSectionData(this.dataset.target);
                });
            });

            // Sidebar Toggle
            document.getElementById('sidebar-toggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const sidebarHeader = document.getElementById('sidebar-header');
                sidebar.classList.toggle('collapsed');
                sidebarHeader.classList.toggle('collapsed');
            });

            // Profile Dropdown Toggle
            const userProfileWidget = document.getElementById('user-profile-widget');
            if(userProfileWidget) { // Check if element exists for Admin
                userProfileWidget.addEventListener('click', function() {
                    this.classList.toggle('active');
                    document.getElementById('profile-dropdown-menu').classList.toggle('active');
                });

                document.addEventListener('click', function(event) {
                    const profileWidget = document.getElementById('user-profile-widget');
                    const dropdownMenu = document.getElementById('profile-dropdown-menu');
                    if (!profileWidget.contains(event.target) && !dropdownMenu.contains(event.target)) {
                        profileWidget.classList.remove('active');
                        dropdownMenu.classList.remove('active');
                    }
                });
            }


            // Dark Mode Toggle
            document.getElementById('dark-mode-toggle').addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                this.querySelector('i').classList.toggle('fa-moon');
                this.querySelector('i').classList.toggle('fa-sun');
            });

            // Apply saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').querySelector('i').classList.add('fa-sun');
                document.getElementById('dark-mode-toggle').querySelector('i').classList.remove('fa-moon');
            }


            // Logout button
            document.getElementById('logout-button').addEventListener('click', handleLogout);

            // Initial data load for the home section
            loadSectionData('home');
            showSection('home-section');

            // Setup Date/Time ticker
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Load app config for banner and accent color
            loadAppConfig();
        }

        function loadAppConfig() {
            google.script.run
                .withSuccessHandler(function(config) {
                    const topbarCompanyLogo = document.getElementById('topbar-company-logo');
                    const currentBannerPreview = document.getElementById('current-banner-preview');
                    const accentColorInput = document.getElementById('accent-color-input');

                    if (config.bannerUrl && config.bannerUrl.trim() !== '') {
                        topbarCompanyLogo.src = config.bannerUrl;
                        if (currentBannerPreview) currentBannerPreview.src = config.bannerUrl;
                    } else {
                        topbarCompanyLogo.src = 'https://via.placeholder.com/40x40?text=Logo';
                        if (currentBannerPreview) currentBannerPreview.src = 'https://via.placeholder.com/300x80?text=No+Banner+Uploaded';
                    }
                    if (config.accentColor && config.accentColor.trim() !== '') {
                        document.documentElement.style.setProperty('--primary-accent-color', config.accentColor);
                        const hoverColor = tinycolor(config.accentColor).darken(10).toString();
                        document.documentElement.style.setProperty('--primary-accent-color-hover', hoverColor);
                        if (accentColorInput) accentColorInput.value = config.accentColor;
                    }
                })
                .withFailureHandler(function(error) {
                    console.error("Error loading app config:", error);
                })
                .getAppConfig();
        }


        function handleLogout() {
            deleteCookie(SESSION_COOKIE_NAME);
            google.script.run
                .withSuccessHandler(function(response) {
                    console.log(response.message);
                    window.top.location.href = '<?= ScriptApp.getService().getUrl(); ?>';
                })
                .withFailureHandler(function(error) {
                    console.error("Logout failed:", error);
                    window.top.location.href = '<?= ScriptApp.getService().getUrl(); ?>';
                })
                .logoutUser(currentSessionId);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedDateTime = now.toLocaleDateString('en-US', options);
            document.getElementById('system-date-time').textContent = `Current: ${formattedDateTime}`;
        }

        function loadSectionData(sectionName) {
            clearMessage(`${sectionName}-message`);
            switch (sectionName) {
                case 'home':
                    adminHomeModule.loadOverviewData();
                    break;
                case 'employees':
                    employeeModule.loadEmployees();
                    break;
                case 'attendance-admin':
                    attendanceAdminModule.loadAttendanceSummary();
                    break;
                case 'tasks-admin':
                    taskAdminModule.loadTasks();
                    break;
                case 'leaves-admin':
                    leaveAdminModule.loadLeaveApplications();
                    break;
                case 'announcements-admin':
                    announcementAdminModule.loadAnnouncements();
                    break;
                case 'policies-admin':
                    policyAdminModule.loadPolicies();
                    break;
                case 'payslips-admin':
                    // No direct load, form is for upload
                    break;
                case 'config':
                    // Config values loaded initially with AppConfig
                    break;
                case 'reports-admin':
                    // Reports section is mostly static or mock
                    break;
            }
        }

        // --- Modules ---

        const adminHomeModule = (function() {
            const totalEmployeesCount = document.getElementById('total-employees-count');
            const activeInactiveEmployees = document.getElementById('active-inactive-employees');
            const todayPresent = document.getElementById('today-present');
            const todayLate = document.getElementById('today-late');
            const todayAbsent = document.getElementById('today-absent');
            const pendingLeavesCount = document.getElementById('pending-leaves-count');
            const openTasks = document.getElementById('open-tasks');
            const submittedTasks = document.getElementById('submitted-tasks');
            const topbarUsername = document.getElementById('topbar-username');
            const topbarProfilePic = document.getElementById('topbar-profile-pic');


            function loadOverviewData() {
                // Get Admin user data first
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success && response.data) {
                            currentUserData = response.data;
                            topbarUsername.textContent = currentUserData.username;
                            topbarProfilePic.src = currentUserData.profilePicUrl || 'https://via.placeholder.com/35x35?text=A';
                        }
                    })
                    .getUserDashboardData(currentSessionId); // Reuse this for basic admin data

                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            // Employee counts
                            const activeCount = response.data.filter(e => e.status === 'Active').length;
                            const inactiveCount = response.data.filter(e => e.status === 'Inactive').length;
                            totalEmployeesCount.textContent = response.data.length;
                            activeInactiveEmployees.textContent = `Active: ${activeCount}, Inactive: ${inactiveCount}`;
                        } else {
                            console.error("Failed to load employee counts:", response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error fetching employee counts:", error);
                    })
                    .getAllEmployeesData();

                // Load today's attendance summary
                const today = new Date().toISOString().split('T')[0];
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            const presentCount = response.data.filter(a => a.status === 'Present' || a.status === 'Checked In').length;
                            const lateCount = response.data.filter(a => a.status === 'Late').length;
                            const absentCount = response.data.filter(a => a.status === 'Absent').length;
                            todayPresent.textContent = `Present: ${presentCount}`;
                            todayLate.textContent = `Late: ${lateCount}`;
                            todayAbsent.textContent = `Absent: ${absentCount}`;
                        } else {
                            console.error("Failed to load attendance summary:", response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error fetching attendance summary:", error);
                    })
                    .getAdminAttendanceSummary(today);

                // Load pending leave requests
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            pendingLeavesCount.textContent = response.data.filter(l => l.status === 'Pending').length;
                        } else {
                            console.error("Failed to load pending leaves:", response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error fetching pending leaves:", error);
                    })
                    .getAllLeaveApplications('pending');

                // Load tasks overview
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            openTasks.textContent = `Open: ${response.data.filter(t => t.status === 'Pending' || t.status === 'In Progress').length}`;
                            submittedTasks.textContent = `Submitted: ${response.data.filter(t => t.status === 'Submitted').length}`;
                        } else {
                            console.error("Failed to load task overview:", response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error fetching task overview:", error);
                    })
                    .getAllTasks('all');

            }

            return {
                loadOverviewData: loadOverviewData
            };
        })();

        const employeeModule = (function() {
            const employeesListContainer = document.getElementById('employees-list-container');
            const addEmployeeBtn = document.getElementById('add-employee-btn');
            const员工Modal = document.getElementById('employee-modal');
            const closeEmployeeModal = document.getElementById('close-employee-modal');
            const employeeForm = document.getElementById('employee-form');
            const employeeModalTitle = document.getElementById('employee-modal-title');
            const saveEmployeeBtn = document.getElementById('save-employee-btn');
            const empUsernameInput = document.getElementById('emp-username');
            const empEmployeeIdInput = document.getElementById('emp-employeeid');
            const empFullnameInput = document.getElementById('emp-fullname');
            const empEmailInput = document.getElementById('emp-email');
            const empPhoneNumberInput = document.getElementById('emp-phonenumber');
            const empDepartmentInput = document.getElementById('emp-department');
            const empRoleSelect = document.getElementById('emp-role');
            const empJoinDateInput = document.getElementById('emp-joindate');
            const empStatusSelect = document.getElementById('emp-status');
            const employeeFormOriginalUsername = document.getElementById('employee-form-original-username');


            addEmployeeBtn.addEventListener('click', () => openEmployeeModal());
            closeEmployeeModal.addEventListener('click', () => hideModal('employee-modal'));
            employeeForm.addEventListener('submit', handleSaveEmployee);
            employeeModal.addEventListener('click', (e) => { // Close when clicking outside
                if (e.target === employeeModal) hideModal('employee-modal');
            });


            function loadEmployees() {
                showSpinner('employees-spinner');
                clearMessage('employees-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('employees-spinner');
                        if (response.success) {
                            renderEmployeesTable(response.data);
                        } else {
                            showMessage('employees-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('employees-spinner');
                        showMessage('employees-message', 'error', `Error loading employees: ${error.message}`);
                    })
                    .getAllEmployeesData();
            }

            function renderEmployeesTable(employees) {
                if (employees.length === 0) {
                    employeesListContainer.innerHTML = '<p class="message info">No employees registered yet.</p>';
                    return;
                }

                let tableHtml = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                employees.forEach(emp => {
                    tableHtml += `
                        <tr>
                            <td>${emp.username}</td>
                            <td>${emp.fullName}</td>
                            <td>${emp.role}</td>
                            <td>${emp.department}</td>
                            <td><span class="status-cell ${emp.status}">${emp.status}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="employeeModule.openEmployeeModal('${emp.username}')" style="font-size:0.8em; padding: 5px 10px; min-width:unset;"><i class="fas fa-edit"></i> Edit</button>
                                <button class="btn btn-danger" onclick="employeeModule.handleDeleteEmployee('${emp.username}')" style="font-size:0.8em; padding: 5px 10px; min-width:unset;"><i class="fas fa-trash-alt"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                employeesListContainer.innerHTML = tableHtml;
            }

            function openEmployeeModal(username = null) {
                clearMessage('employee-modal-message');
                employeeForm.reset();
                empUsernameInput.readOnly = false; // Enable for new employee

                if (username) {
                    employeeModalTitle.textContent = 'Edit Employee';
                    employeeFormOriginalUsername.value = username; // Store original username for updates
                    empUsernameInput.readOnly = true; // Disable username change for edit
                    // Load employee data into form
                    showSpinner('employee-modal-spinner');
                    google.script.run
                        .withSuccessHandler(function(response) {
                            hideSpinner('employee-modal-spinner');
                            if (response.success && response.data.length > 0) {
                                const emp = response.data.find(e => e.username === username);
                                if (emp) {
                                    empUsernameInput.value = emp.username;
                                    empEmployeeIdInput.value = emp.employeeId;
                                    empFullnameInput.value = emp.fullName;
                                    empEmailInput.value = emp.email;
                                    empPhoneNumberInput.value = emp.phoneNumber;
                                    empDepartmentInput.value = emp.department;
                                    empRoleSelect.value = emp.role;
                                    empJoinDateInput.value = emp.joinDate ? new Date(emp.joinDate).toISOString().split('T')[0] : '';
                                    empStatusSelect.value = emp.status;
                                } else {
                                    showMessage('employee-modal-message', 'error', 'Employee data not found.');
                                }
                            } else {
                                showMessage('employee-modal-message', 'error', response.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            hideSpinner('employee-modal-spinner');
                            showMessage('employee-modal-message', 'error', `Error loading employee data: ${error.message}`);
                        })
                        .getAllEmployeesData(); // Reusing general method, ideally have getEmployeeByUsername
                } else {
                    employeeModalTitle.textContent = 'Add New Employee';
                    empEmployeeIdInput.value = ''; // Clear EMployee ID for new employees
                }
                showModal('employee-modal');
            }

            function handleSaveEmployee(e) {
                e.preventDefault();
                showSpinner('employee-modal-spinner');
                clearMessage('employee-modal-message');

                const employeeData = {
                    username: empUsernameInput.value,
                    employeeId: empEmployeeIdInput.value,
                    fullName: empFullnameInput.value,
                    email: empEmailInput.value,
                    phoneNumber: empPhoneNumberInput.value,
                    department: empDepartmentInput.value,
                    role: empRoleSelect.value,
                    joinDate: empJoinDateInput.value,
                    status: empStatusSelect.value
                };

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('employee-modal-spinner');
                        if (response.success) {
                            showMessage('employee-modal-message', 'success', response.message);
                            employeeForm.reset();
                            hideModal('employee-modal');
                            loadEmployees(); // Refresh list
                            adminHomeModule.loadOverviewData(); // Refresh summary counts
                        } else {
                            showMessage('employee-modal-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('employee-modal-spinner');
                        showMessage('employee-modal-message', 'error', `Error saving employee: ${error.message}`);
                    })
                    .addUpdateEmployee(employeeData);
            }

            function handleDeleteEmployee(username) {
                if (!confirm(`Are you sure you want to delete employee "${username}"? This action cannot be undone.`)) {
                    return;
                }
                showSpinner('employees-spinner');
                clearMessage('employees-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('employees-spinner');
                        if (response.success) {
                            showMessage('employees-message', 'success', response.message);
                            loadEmployees(); // Refresh list
                            adminHomeModule.loadOverviewData(); // Refresh summary counts
                        } else {
                            showMessage('employees-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('employees-spinner');
                        showMessage('employees-message', 'error', `Error deleting employee: ${error.message}`);
                    })
                    .deleteEmployee(username);
            }

            return {
                loadEmployees: loadEmployees,
                openEmployeeModal: openEmployeeModal,
                handleDeleteEmployee: handleDeleteEmployee
            };
        })();


        const attendanceAdminModule = (function() {
            const filterDateInput = document.getElementById('attendance-date-filter');
            const filterAttendanceBtn = document.getElementById('filter-attendance-btn');
            const attendanceSummaryContainer = document.getElementById('admin-attendance-summary-container');

            filterAttendanceBtn.addEventListener('click', loadAttendanceSummary);

            function loadAttendanceSummary() {
                showSpinner('attendance-admin-spinner');
                clearMessage('attendance-admin-message');

                const selectedDate = filterDateInput.value; // YYYY-MM-DD

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('attendance-admin-spinner');
                        if (response.success) {
                            renderAttendanceSummary(response.data, response.date);
                        } else {
                            showMessage('attendance-admin-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('attendance-admin-spinner');
                        showMessage('attendance-admin-message', 'error', `Error loading attendance summary: ${error.message}`);
                    })
                    .getAdminAttendanceSummary(selectedDate);
            }

            function renderAttendanceSummary(summary, date) {
                if (summary.length === 0) {
                    attendanceSummaryContainer.innerHTML = `<p class="message info">No attendance records for ${new Date(date).toLocaleDateString()}.</p>`;
                    return;
                }

                let tableHtml = `
                    <h4 style="margin-bottom: 20px;">Attendance for ${new Date(date).toLocaleDateString()}</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                summary.forEach(record => {
                    tableHtml += `
                        <tr>
                            <td>${record.id}</td>
                            <td>${record.username}</td>
                            <td>${record.fullName}</td>
                            <td>${record.department}</td>
                            <td><span class="status-cell ${record.status.replace(/\s/g, '')}">${record.status}</span></td>
                            <td>${record.checkInTime || 'N/A'} ${record.geoLocationIn ? `<i title="Location: ${record.geoLocationIn}" class="fas fa-map-marker-alt"></i>` : ''}</td>
                            <td>${record.checkOutTime || 'N/A'} ${record.geoLocationOut ? `<i title="Location: ${record.geoLocationOut}" class="fas fa-map-marker-alt"></i>` : ''}</td>
                            <td>
                                <!-- Add manual override buttons if desired (requires more backend logic) -->
                                <button class="btn btn-secondary" style="font-size:0.7em; padding: 5px; min-width:unset;" title="Edit Attendance (Mock)"><i class="fas fa-pencil-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                attendanceSummaryContainer.innerHTML = tableHtml;
            }

            return {
                loadAttendanceSummary: loadAttendanceSummary
            };
        })();

        const taskAdminModule = (function() {
            const assignTaskBtn = document.getElementById('assign-task-btn');
            const assignTaskModal = document.getElementById('assign-task-modal');
            const closeAssignTaskModal = document.getElementById('close-assign-task-modal');
            const assignTaskForm = document.getElementById('assign-task-form');
            const taskAdminFilter = document.getElementById('task-admin-filter');
            const tasksAdminListContainer = document.getElementById('tasks-admin-list-container');

            assignTaskBtn.addEventListener('click', openAssignTaskModal);
            closeAssignTaskModal.addEventListener('click', () => hideModal('assign-task-modal'));
            assignTaskModal.addEventListener('click', (e) => { if (e.target === assignTaskModal) hideModal('assign-task-modal'); });
            assignTaskForm.addEventListener('submit', handleAssignTask);
            taskAdminFilter.addEventListener('change', loadTasks);

            function loadTasks() {
                showSpinner('tasks-admin-spinner');
                clearMessage('tasks-admin-message');

                const filter = taskAdminFilter.value;
                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('tasks-admin-spinner');
                        if (response.success) {
                            renderTasksTable(response.data);
                        } else {
                            showMessage('tasks-admin-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('tasks-admin-spinner');
                        showMessage('tasks-admin-message', 'error', `Error loading tasks: ${error.message}`);
                    })
                    .getAllTasks(filter);
            }

            function renderTasksTable(tasks) {
                if (tasks.length === 0) {
                    tasksAdminListContainer.innerHTML = '<p class="message info">No tasks found for this filter.</p>';
                    return;
                }

                let tableHtml = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Assigned To</th>
                                <th>Assigned By</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                tasks.forEach(task => {
                    tableHtml += `
                        <tr>
                            <td>${task.title}</td>
                            <td>${task.assignedTo}</td>
                            <td>${task.assignedBy}</td>
                            <td>${new Date(task.dueDate).toLocaleDateString()}</td>
                            <td><span class="status-cell ${task.status.replace(/\s/g, '')}">${task.status}</span></td>
                             <td><div class="task-progress-bar-container" style="width: 100px; margin: 0; box-shadow: none;">
                                    <div class="task-progress-bar" style="width: ${task.progress || 0}%;"></div>
                                </div> ${task.progress || 0}%
                            </td>
                            <td>
                                <!-- View Details, Approve/Reject -->
                                ${['Submitted', 'Completed'].includes(task.status) ?
                                    `<button class="btn btn-success" onclick="taskAdminModule.handleTaskApproval('${task.taskId}', 'Approved')" style="font-size:0.7em; padding: 5px; min-width:unset;"><i class="fas fa-check"></i> Approve</button>
                                    <button class="btn btn-danger" onclick="taskAdminModule.handleTaskApproval('${task.taskId}', 'Rejected')" style="font-size:0.7em; padding: 5px; min-width:unset;"><i class="fas fa-times"></i> Reject</button>`
                                    : ''
                                }
                                <button class="btn btn-secondary" onclick="alert('Task Details:\\nTitle: ${task.title}\\nDescription: ${task.description}\\nComments: ${task.comments}')" style="font-size:0.7em; padding: 5px; min-width:unset;"><i class="fas fa-info-circle"></i> View</button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                tasksAdminListContainer.innerHTML = tableHtml;
            }

            function openAssignTaskModal() {
                clearMessage('assign-task-modal-message');
                assignTaskForm.reset();
                // Set default due date to a month from now
                const today = new Date();
                const dueDate = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
                document.getElementById('task-due-date').valueAsDate = dueDate;
                showModal('assign-task-modal');
            }

            function handleAssignTask(e) {
                e.preventDefault();
                showSpinner('assign-task-modal-spinner');
                clearMessage('assign-task-modal-message');

                const taskData = {
                    assignedToUsername: document.getElementById('task-assign-to').value,
                    title: document.getElementById('task-title').value,
                    description: document.getElementById('task-description').value,
                    type: document.getElementById('task-type').value,
                    priority: document.getElementById('task-priority').value,
                    dueDate: document.getElementById('task-due-date').value
                };

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('assign-task-modal-spinner');
                        if (response.success) {
                            showMessage('assign-task-modal-message', 'success', response.message);
                            assignTaskForm.reset();
                            hideModal('assign-task-modal');
                            loadTasks(); // Refresh tasks list
                        } else {
                            showMessage('assign-task-modal-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('assign-task-modal-spinner');
                        showMessage('assign-task-modal-message', 'error', `Error assigning task: ${error.message}`);
                    })
                    .assignTask(currentUserData.username, taskData);
            }

            function handleTaskApproval(taskId, status) {
                let comments = prompt(`Enter comments for ${status}ing task "${taskId}" (optional):`);
                if (comments === null) return; // User cancelled

                showSpinner('tasks-admin-spinner');
                clearMessage('tasks-admin-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('tasks-admin-spinner');
                        if (response.success) {
                            showMessage('tasks-admin-message', 'success', response.message);
                            loadTasks(); // Refresh tasks list
                        } else {
                            showMessage('tasks-admin-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('tasks-admin-spinner');
                        showMessage('tasks-admin-message', 'error', `Error processing task: ${error.message}`);
                    })
                    .approveRejectTask(currentUserData.username, taskId, status, comments);

            }


            return {
                loadTasks: loadTasks,
                handleTaskApproval: handleTaskApproval
            };
        })();

        const leaveAdminModule = (function() {
            const leaveAdminFilter = document.getElementById('leave-admin-filter');
            const leavesAdminListContainer = document.getElementById('leaves-admin-list-container');

            leaveAdminFilter.addEventListener('change', loadLeaveApplications);

            function loadLeaveApplications() {
                showSpinner('leaves-admin-spinner');
                clearMessage('leaves-admin-message');

                const filter = leaveAdminFilter.value;
                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('leaves-admin-spinner');
                        if (response.success) {
                            renderLeaveApplicationsTable(response.data);
                        } else {
                            showMessage('leaves-admin-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('leaves-admin-spinner');
                        showMessage('leaves-admin-message', 'error', `Error loading leave applications: ${error.message}`);
                    })
                    .getAllLeaveApplications(filter);
            }

            function renderLeaveApplicationsTable(applications) {
                if (applications.length === 0) {
                    leavesAdminListContainer.innerHTML = '<p class="message info">No leave applications found for this filter.</p>';
                    return;
                }

                let tableHtml = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Type</th>
                                <th>Dates</th>
                                <th>Days</th>
                                <th>Reason</th>
                                <th>Applied On</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                applications.forEach(app => {
                    const viewActionHtml = app.attachmentUrl ? `<a href="${app.attachmentUrl}" target="_blank" class="btn btn-secondary" style="font-size:0.7em; padding: 5px; min-width:unset;" title="View Attachment"><i class="fas fa-paperclip"></i></a>` : '';
                    tableHtml += `
                        <tr>
                            <td>${app.username} (${app.employeeId})</td>
                            <td>${app.leaveType}</td>
                            <td>${new Date(app.startDate).toLocaleDateString()} - ${new Date(app.endDate).toLocaleDateString()}</td>
                            <td>${app.numDays}</td>
                            <td>${app.reason}</td>
                            <td>${new Date(app.appliedAt).toLocaleDateString()}</td>
                            <td><span class="status-cell ${app.status}">${app.status}</span></td>
                            <td>
                                ${app.status === 'Pending' ? `
                                    <button class="btn btn-success" onclick="leaveAdminModule.handleLeaveAction('${app.leaveId}', 'Approved')" style="font-size:0.7em; padding: 5px; min-width:unset;"><i class="fas fa-check"></i> Approve</button>
                                    <button class="btn btn-danger" onclick="leaveAdminModule.handleLeaveAction('${app.leaveId}', 'Rejected')" style="font-size:0.7em; padding: 5px; min-width:unset;"><i class="fas fa-times"></i> Reject</button>
                                ` : ''}
                                ${viewActionHtml}
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                leavesAdminListContainer.innerHTML = tableHtml;
            }

            function handleLeaveAction(leaveId, status) {
                let reason = '';
                if (status === 'Rejected') {
                    reason = prompt('Reason for rejection (optional):');
                    if (reason === null) return; // User cancelled
                }
                showSpinner('leaves-admin-spinner');
                clearMessage('leaves-admin-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('leaves-admin-spinner');
                        if (response.success) {
                            showMessage('leaves-admin-message', 'success', response.message);
                            loadLeaveApplications(); // Refresh list
                            adminHomeModule.loadOverviewData(); // Refresh summary counts
                        } else {
                            showMessage('leaves-admin-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('leaves-admin-spinner');
                        showMessage('leaves-admin-message', 'error', `Error processing leave: ${error.message}`);
                    })
                    .approveRejectLeaveApplication(currentUserData.username, leaveId, status, reason);
            }

            return {
                loadLeaveApplications: loadLeaveApplications,
                handleLeaveAction: handleLeaveAction
            };
        })();

        const announcementAdminModule = (function() {
            const createAnnouncementForm = document.getElementById('create-announcement-form');
            const announcementTitleInput = document.getElementById('announcement-title');
            const announcementContentInput = document.getElementById('announcement-content');
            const announcementValidUntilInput = document.getElementById('announcement-valid-until');
            const existingAnnouncementsList = document.getElementById('existing-announcements-list');

            createAnnouncementForm.addEventListener('submit', handleCreateAnnouncement);

            function loadAnnouncements() {
                showSpinner('existing-announcements-spinner');
                clearMessage('existing-announcements-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('existing-announcements-spinner');
                        if (response.success) {
                            renderAnnouncementsList(response.data);
                        } else {
                            showMessage('existing-announcements-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('existing-announcements-spinner');
                        showMessage('existing-announcements-message', 'error', `Error loading announcements: ${error.message}`);
                    })
                    .getAnnouncements();
            }

            function renderAnnouncementsList(announcements) {
                existingAnnouncementsList.innerHTML = '';
                if (announcements.length === 0) {
                    existingAnnouncementsList.innerHTML = '<p class="message info">No announcements created yet.</p>';
                    return;
                }
                announcements.forEach(ann => {
                    const div = document.createElement('div');
                    div.className = 'announcement-item';
                    const validUntil = ann.validUntil ? `Valid until: ${new Date(ann.validUntil).toLocaleDateString()}` : 'No expiry';
                    div.innerHTML = `
                        <h4>${ann.title}</h4>
                        <p>${ann.content}</p>
                        <div class="meta">Posted by ${ann.createdBy} on ${new Date(ann.createdAt).toLocaleDateString()} | ${validUntil}</div>
                        <button class="delete-btn" data-announcement-id="${ann.announcementId}" title="Delete Announcement"><i class="fas fa-trash"></i></button>
                    `;
                    existingAnnouncementsList.appendChild(div);
                });

                existingAnnouncementsList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        handleDeleteAnnouncement(this.dataset.announcementId);
                    });
                });
            }

            function handleCreateAnnouncement(e) {
                e.preventDefault();
                showSpinner('create-announcement-spinner');
                clearMessage('create-announcement-message');

                const announcementData = {
                    title: announcementTitleInput.value,
                    content: announcementContentInput.value,
                    validUntil: announcementValidUntilInput.value
                };

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('create-announcement-spinner');
                        if (response.success) {
                            showMessage('create-announcement-message', 'success', response.message);
                            createAnnouncementForm.reset();
                            loadAnnouncements(); // Refresh list
                        } else {
                            showMessage('create-announcement-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('create-announcement-spinner');
                        showMessage('create-announcement-message', 'error', `Error creating announcement: ${error.message}`);
                    })
                    .createAnnouncement(currentUserData.username, announcementData);
            }

            function handleDeleteAnnouncement(announcementId) {
                if (!confirm('Are you sure you want to delete this announcement?')) {
                    return;
                }
                showSpinner('existing-announcements-spinner');
                clearMessage('existing-announcements-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('existing-announcements-spinner');
                        if (response.success) {
                            showMessage('existing-announcements-message', 'success', response.message);
                            loadAnnouncements(); // Refresh list
                        } else {
                            showMessage('existing-announcements-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('existing-announcements-spinner');
                        showMessage('existing-announcements-message', 'error', `Error deleting announcement: ${error.message}`);
                    })
                    .deleteAnnouncement(announcementId);
            }

            return {
                loadAnnouncements: loadAnnouncements
            };
        })();

        const policyAdminModule = (function() {
            const policyForm = document.getElementById('policy-form');
            const policyIdInput = document.getElementById('policy-id');
            const policyTitleInput = document.getElementById('policy-title');
            const policyDescriptionInput = document.getElementById('policy-description');
            const policyDocumentUrlInput = document.getElementById('policy-document-url');
            const existingPoliciesList = document.getElementById('existing-policies-list');
            const savePolicyBtn = document.getElementById('save-policy-btn');
            const resetPolicyFormBtn = document.getElementById('reset-policy-form-btn');

            policyForm.addEventListener('submit', handleSavePolicy);
            resetPolicyFormBtn.addEventListener('click', resetPolicyForm);

            function loadPolicies() {
                showSpinner('existing-policies-spinner');
                clearMessage('existing-policies-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('existing-policies-spinner');
                        if (response.success) {
                            renderPoliciesList(response.data);
                        } else {
                            showMessage('existing-policies-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('existing-policies-spinner');
                        showMessage('existing-policies-message', 'error', `Error loading policies: ${error.message}`);
                    })
                    .getCompanyPolicies();
            }

            function renderPoliciesList(policies) {
                existingPoliciesList.innerHTML = '';
                if (policies.length === 0) {
                    existingPoliciesList.innerHTML = '<p class="message info">No policies created yet.</p>';
                    return;
                }
                policies.forEach(policy => {
                    const div = document.createElement('div'); // Using div instead of a to allow nested buttons
                    div.className = 'policy-list-item';
                    div.innerHTML = `
                        <h4>${policy.title}</h4>
                        <div class="policy-actions">
                            <button class="btn-secondary" onclick="policyAdminModule.editPolicy('${policy.policyId}')" title="Edit Policy"><i class="fas fa-pencil-alt"></i></button>
                            <a href="${policy.documentUrl}" target="_blank" class="btn-secondary" title="View Document"><i class="fas fa-eye"></i></a>
                            <button class="btn-danger delete-btn" onclick="policyAdminModule.deletePolicy('${policy.policyId}')" title="Delete Policy"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    existingPoliciesList.appendChild(div);
                });
            }

            function resetPolicyForm() {
                policyForm.reset();
                policyIdInput.value = '';
                savePolicyBtn.textContent = 'Save Policy';
                savePolicyBtn.querySelector('i').className = 'fas fa-save';
            }

            function handleSavePolicy(e) {
                e.preventDefault();
                showSpinner('policy-spinner');
                clearMessage('policy-message');

                const policyData = {
                    policyId: policyIdInput.value || null, // Will be null for new policies
                    title: policyTitleInput.value,
                    description: policyDescriptionInput.value,
                    documentUrl: policyDocumentUrlInput.value
                };

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('policy-spinner');
                        if (response.success) {
                            showMessage('policy-message', 'success', response.message);
                            resetPolicyForm();
                            loadPolicies(); // Refresh list
                        } else {
                            showMessage('policy-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('policy-spinner');
                        showMessage('policy-message', 'error', `Error saving policy: ${error.message}`);
                    })
                    .addUpdatePolicy(policyData);
            }

            function editPolicy(policyId) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success && response.data) {
                            const policy = response.data.find(p => p.policyId === policyId);
                            if (policy) {
                                policyIdInput.value = policy.policyId;
                                policyTitleInput.value = policy.title;
                                policyDescriptionInput.value = policy.description;
                                policyDocumentUrlInput.value = policy.documentUrl;
                                savePolicyBtn.textContent = 'Update Policy';
                                savePolicyBtn.querySelector('i').className = 'fas fa-edit';
                            }
                        }
                    })
                    .withFailureHandler(function(error) {
                        showMessage('policy-message', 'error', `Error fetching policy to edit: ${error.message}`);
                    })
                    .getCompanyPolicies(); // Get all to find by ID
            }

            function deletePolicy(policyId) {
                if (!confirm('Are you sure you want to delete this policy?')) {
                    return;
                }
                showSpinner('existing-policies-spinner');
                clearMessage('existing-policies-message');

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('existing-policies-spinner');
                        if (response.success) {
                            showMessage('existing-policies-message', 'success', response.message);
                            loadPolicies(); // Refresh list
                        } else {
                            showMessage('existing-policies-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('existing-policies-spinner');
                        showMessage('existing-policies-message', 'error', `Error deleting policy: ${error.message}`);
                    })
                    .deletePolicy(policyId);
            }

            return {
                loadPolicies: loadPolicies,
                editPolicy: editPolicy,
                deletePolicy: deletePolicy
            };
        })();

        const payslipAdminModule = (function() {
            const payslipUploadForm = document.getElementById('payslip-upload-form');
            const payslipUsernameInput = document.getElementById('payslip-username');
            const payslipMonthYearInput = document.getElementById('payslip-month-year');
            const payslipFileInput = document.getElementById('payslip-file');
            const payslipCommentInput = document.getElementById('payslip-comment');

            payslipUploadForm.addEventListener('submit', handlePayslipUpload);

            function handlePayslipUpload(e) {
                e.preventDefault();
                showSpinner('payslip-admin-spinner');
                clearMessage('payslip-admin-message');

                const file = payslipFileInput.files[0];
                if (!file) {
                    showMessage('payslip-admin-message', 'error', 'Please select a PDF file to upload.');
                    hideSpinner('payslip-admin-spinner');
                    return;
                }

                const fr = new FileReader();
                fr.onload = function(f) {
                    const fileData = f.target.result; // base64 string
                    const fileName = file.name;

                    const payslipData = {
                        username: payslipUsernameInput.value,
                        monthYear: payslipMonthYearInput.value,
                        comment: payslipCommentInput.value,
                        fileName: fileName // Pass filename for backend debugging if needed
                    };

                    google.script.run
                        .withSuccessHandler(function(response) {
                            hideSpinner('payslip-admin-spinner');
                            if (response.success) {
                                showMessage('payslip-admin-message', 'success', response.message);
                                payslipUploadForm.reset();
                            } else {
                                showMessage('payslip-admin-message', 'error', response.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            hideSpinner('payslip-admin-spinner');
                            showMessage('payslip-admin-message', 'error', `Error uploading payslip: ${error.message}`);
                        })
                        .withFileUpload(fileData)
                        .uploadPayslip(payslipData); // Pass object with file and other metadata
                };
                fr.readAsDataURL(file);
            }
            return {};
        })();

        const configModule = (function() {
            const bannerUploadForm = document.getElementById('banner-upload-form');
            const bannerFileInput = document.getElementById('banner-file-input');
            const accentColorForm = document.getElementById('accent-color-form');
            const accentColorInput = document.getElementById('accent-color-input');

            bannerUploadForm.addEventListener('submit', handleBannerUpload);
            accentColorForm.addEventListener('submit', handleAccentColorUpdate);

            function handleBannerUpload(e) {
                e.preventDefault();
                showSpinner('banner-spinner');
                clearMessage('banner-message');

                const file = bannerFileInput.files[0];
                if (!file) {
                    showMessage('banner-message', 'error', 'Please select a banner image.');
                    hideSpinner('banner-spinner');
                    return;
                }

                const fr = new FileReader();
                fr.onload = function(f) {
                    const fileData = f.target.result; // base64 string

                    google.script.run
                        .withSuccessHandler(function(response) {
                            hideSpinner('banner-spinner');
                            if (response.success) {
                                showMessage('banner-message', 'success', response.message);
                                document.getElementById('current-banner-preview').src = response.fileUrl; // Update preview
                                document.getElementById('topbar-company-logo').src = response.fileUrl; // Update topbar logo
                                bannerFileInput.value = ''; // Clear file input
                            } else {
                                showMessage('banner-message', 'error', response.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            hideSpinner('banner-spinner');
                            showMessage('banner-message', 'error', `Error uploading banner: ${error.message}`);
                        })
                        .withFileUpload(fileData)
                        .uploadBanner();
                };
                fr.readAsDataURL(file);
            }

            function handleAccentColorUpdate(e) {
                e.preventDefault();
                showSpinner('accent-color-spinner');
                clearMessage('accent-color-message');

                const newAccentColor = accentColorInput.value;

                google.script.run
                    .withSuccessHandler(function(response) {
                        hideSpinner('accent-color-spinner');
                        if (response.success) {
                            showMessage('accent-color-message', 'success', response.message);
                            document.documentElement.style.setProperty('--primary-accent-color', newAccentColor);
                            const hoverColor = tinycolor(newAccentColor).darken(10).toString();
                            document.documentElement.style.setProperty('--primary-accent-color-hover', hoverColor);
                        } else {
                            showMessage('accent-color-message', 'error', response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideSpinner('accent-color-spinner');
                        showMessage('accent-color-message', 'error', `Error updating accent color: ${error.message}`);
                    })
                    .updateAppConfig('accentColor', newAccentColor);
            }
            return {};
        })();

        // Initialize the admin dashboard when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeAdminDashboard);
    </script>
</body>
</html>
